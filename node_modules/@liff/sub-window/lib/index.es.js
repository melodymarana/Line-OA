import{STORE_KEY as e,INVALID_CONFIG as t,EXCEPTION_IN_SUBWINDOW as n,SUB_WINDOW_STATUS as r,CREATE_SUBWINDOW_FAILED as i,SUB_WINDOW_HEALTH_CHECK_INTERVAL as s,SUB_WINDOW_MONITOR_CLOSE_INTERVAL as o,SUB_WINDOW_IDNTIFICATION_KEY as u,INVALID_ARGUMENT as a,SUB_WINDOW_HEALTH_CHECK_MESSAGE as c,UNKNOWN as f,UNAUTHORIZED as l,SUB_WINDOW_MODAL_SCHEME_URL as d,FORBIDDEN as m}from"@liff/consts";import{createLiffError as v,inMemoryStorage as p,isIpad as h,extractLiffId as w}from"@liff/util";import{isInClient as g}from"@liff/is-in-client";import{isApiAvailable as b}from"@liff/is-api-available";import{__awaiter as S,__generator as y,__spread as I,__read as C}from"tslib";import{logger as O}from"@liff/logger";import{getOS as P}from"@liff/get-os";import{fetch as L,getEndPoint as E,requestWithoutErrorHandling as N}from"@liff/server-api";import{getConfig as T,getMSTChallenge as j,getMST as M,getAppData as B}from"@liff/store";import D,{WINDOW as J,IDENTIFIER_KEY as R,CRYPTO_KEY as U}from"@liff/message-bus";import{isSubWindow as W}from"@liff/is-sub-window";import{closeWindow as A}from"@liff/close-window";function x(e){var t=E("subWindowGetOrigin");return L(t(e))}var k={};function K(e,t){e&&k[e]&&k[e].forEach((function(e){e(t)}))}var G,V,F,_,q,z=function(){function n(e){this.storage=e}return n.prototype.getItem=function(e){return this.storage.getItem(this.getKeyPrefix()+":"+e)},n.prototype.setItem=function(e,t){this.storage.setItem(this.getKeyPrefix()+":"+e,t)},n.prototype.removeItem=function(e){this.storage.removeItem(this.getKeyPrefix()+":"+e)},n.prototype.clear=function(){this.storage.clear()},n.prototype.getKeyPrefix=function(){return e+":"+this.getLiffId()},n.prototype.getLiffId=function(){var e=T().liffId;if(!e)throw v(t,"liffId is necessary for liff.init()");return e},n}(),H=new z(p);function Q(){var e=H.getItem("subWindowStatusUpdated");return null!==e&&JSON.parse(e)}function X(e){H.setItem("subWindowStatusUpdated",String(e))}function Y(e){G=e}function Z(){return G}function $(){return F}function ee(){return _}function te(e){return void 0===e&&(e=J.MAIN),S(this,void 0,void 0,(function(){return y(this,(function(t){switch(t.label){case 0:return[4,(q=new D(e)).setup()];case 1:return t.sent(),[2,q]}}))}))}function ne(){return q}var re=new z(window.sessionStorage);function ie(e){re.setItem("mainWindowOrigin",e)}function se(){return re.getItem("mainWindowOrigin")}function oe(e,t){return void 0===t&&(t={}),S(this,void 0,void 0,(function(){var i,s,o,u,a,c,f,l;return y(this,(function(d){switch(d.label){case 0:if(null==(i=ne())?void 0:i.isReady())return[3,5];if(s=JSON.stringify(t),o=T().liffId,u=se(),!window.opener||!u||!o)throw v(n);a=!1,d.label=1;case 1:return d.trys.push([1,3,,4]),[4,x(o)];case 2:return c=d.sent(),a=c.subwindowCommonModule,[3,4];case 3:throw f=d.sent(),O.debug(f),v(n);case 4:return l=a?u:location.origin,[2,new Promise((function(t){window.addEventListener("message",(function n(i){(function(e){if(e.data&&"string"==typeof e.data.type&&[r.SUBMIT,r.CANCEL].includes(e.data.type))return!0;return!1})(i)&&(window.removeEventListener("message",n),t({status:e,result:s}))})),window.opener.postMessage({status:e,result:s},l)}))];case 5:return i.send({eventName:e,data:t}),[4,new Promise((function(e){setTimeout(e,500)}))];case 6:return d.sent(),[2,{status:e,result:JSON.stringify(t)}]}}))}))}function ue(e){var t,n=ee();if(e.origin===n){var i=e.data;if(i){var s,o=i.status,u=i.result;try{s=JSON.parse(u||"{}")}catch(a){s={}}switch(o){case c:window.clearInterval($()),le();break;case r.CANCEL:case r.SUBMIT:X(!0),window.clearInterval($()),window.removeEventListener("message",ue),K(o,s),null===(t=Z())||void 0===t||t.postMessage({type:o},ee());break;default:O.debug("unexpected message")}}}}var ae=function(e){return S(void 0,void 0,void 0,(function(){var t,n,i,s;return y(this,(function(o){if(Q())return[2];switch(t=e.context,n=t.eventName,i=t.data,s=ne(),n){case r.INIT:fe(!i.hasOpener);break;case r.CANCEL:case r.SUBMIT:X(!0),K(n,i),null==s||s.reply(e,{eventName:n});break;case r.CLOSE:!1===Q()&&(X(!0),K(r.CLOSE,{})),le()}return[2]}))}))};function ce(){window.clearInterval(V),window.clearInterval($()),window.removeEventListener("message",ue)}function fe(e){if(void 0===e&&(e=!1),ce(),X(!1),e){var t=Z();t&&(t.close(),Y(null))}}function le(){return S(this,void 0,void 0,(function(){var e;return y(this,(function(t){switch(t.label){case 0:return(e=ne())?[4,e.teardown()]:[3,2];case 1:t.sent(),t.label=2;case 2:return[2]}}))}))}function de(e){return S(this,void 0,void 0,(function(){var t,n,f,l,d,m,p,g,b,S;return y(this,(function(y){switch(y.label){case 0:return(t=w(e.url))?(fe(!0),[4,le()]):[2,Promise.reject(v(a,"params.url must be liff url"))];case 1:return y.sent(),n=e.url,f=e.appData,(l=new URL(n)).searchParams.append(u,"true"),[4,te()];case 2:return d=y.sent(),l.searchParams.append(R,d.identification.identifier),l.searchParams.append(U,d.identification.cryptoKey),l.hostname=function(e){var t=C(e.split(".")),n=t[0],r=t.slice(1);return I([n+"-ext"],r).join(".")}(l.hostname),m=l.toString(),Y("ios"!==P()||h()?window.open("","liffsubwindow","width=480, height=640, menubar=no, toolbar=no, scrollbars=yes"):window.open()),[4,x(t)];case 3:if(p=y.sent(),g=p.origin,b=p.subwindowCommonModule,!(S=Z()))throw v(i);return b?(function(e){_=e}(g),d.listen(ae),d.setData("appData",f),window.addEventListener("message",ue),S.location.href=m,O=function(e,t){var n=Z(),r={type:c};return t&&(r.message=JSON.stringify(t)),window.setInterval((function(){null==n||n.postMessage(r,e)}),s)}(g,f),F=O,function(e){V=e}(window.setInterval((function(){var e=Z();e&&e.closed&&(ce(),Y(null),!1===Q()&&(X(!0),K(r.CLOSE,{})))}),o)),[2]):(S.close(),[2])}var O}))}))}function me(e){return S(this,void 0,void 0,(function(){var t,n,i,s,o,u,c,l,d,m,p;return y(this,(function(h){switch(h.label){case 0:t=e.msit,n=e.mstChallenge,i=e.onSuccess,s=e.onError,o=e.reconnectCount,u=void 0===o?0:o,h.label=1;case 1:return h.trys.push([1,3,,6]),[4,N(E("subWindowSubscribe"),{method:"POST",body:JSON.stringify({msit:t,mstChallenge:n})})];case 2:return c=h.sent(),[3,6];case 3:return h.sent(),[4,ve()];case 4:return h.sent(),[4,he(me,{msit:t,mstChallenge:n,onSuccess:i,onError:s,reconnectCount:u+=1})];case 5:return h.sent(),[2];case 6:return c.status>=500?[4,ve()]:[3,9];case 7:return h.sent(),[4,he(me,{msit:t,mstChallenge:n,onSuccess:i,onError:s,reconnectCount:u+=1})];case 8:return h.sent(),[3,20];case 9:return c.status>=400&&500>c.status?[4,pe(c)]:[3,11];case 10:return(d=h.sent())?(l=d.errorDetail,s(v(a,l))):s(v(f,"Some error happened in the server")),[3,20];case 11:return 200!==c.status?[3,19]:[4,pe(c)];case 12:return(d=h.sent())?[3,13]:(s(v(f,"Some error happened in the server")),[3,18]);case 13:switch(m=d.status,p=d.result,m){case r.ERROR:return[3,14];case r.CLOSE:case r.CANCEL:case r.SUBMIT:return[3,16]}return[3,17];case 14:return[4,he(me,{msit:t,mstChallenge:n,onSuccess:i,onError:s,reconnectCount:u})];case 15:return h.sent(),[3,18];case 16:return i(m,p),[3,18];case 17:s(v(f,"Some error happened in the server")),h.label=18;case 18:return[3,20];case 19:s(v(f,"Some error happened in the server")),h.label=20;case 20:return[2]}}))}))}function ve(){return new Promise((function(e){return setTimeout(e,1e3)}))}function pe(e){return S(this,void 0,void 0,(function(){return y(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,e.json()];case 1:return[2,t.sent()];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))}function he(e,t){return S(this,void 0,void 0,(function(){return y(this,(function(n){switch(n.label){case 0:return t.reconnectCount>=10?(t.onError(v(f,"Failed to connect")),[3,3]):[3,1];case 1:return[4,e(t)];case 2:n.sent(),n.label=3;case 3:return[2]}}))}))}function we(e){var t={};return Object.keys(e).forEach((function(n){"closeButtonColor"===n?"white"===e[n]?t[n]="#ffffff":t[n]="#000000":t[n]=e[n]})),t}var ge={height:"full",closeButtonPosition:"right",closeButtonColor:"black",closeButtonLabel:""};function be(e){var t=e.appData,n=e.native,i=T().liffId,s=j(),o=w(e.url);if(!i)return Promise.reject(v(l,"liffId is invalid"));if(!s)return Promise.reject(v(l,"mst_challenge is invalid"));if(!o)return Promise.reject(v(a,"params.url must be liff url"));var u=Object.assign({},ge,n);return function(e){var t=e.mainLiffId,n=e.subLiffId,r=e.mstChallenge,i=e.appData,s=e.view;return t&&r?L(E("subWindowGetMSIT"),{method:"POST",body:JSON.stringify({mainLiffId:t,subLiffId:n,mstChallenge:r,appData:i,view:s})}):Promise.reject(v(a,"no proper argument"))}({mainLiffId:i,subLiffId:o,mstChallenge:s,appData:t,view:we(u)}).then((function(t){var n=t.msit;me({msit:n,mstChallenge:s,onSuccess:function(e,t){K(e,t)},onError:function(e){K(r.ERROR,e)}}),function(e,t){var n=e.url,r=new URLSearchParams;r.set("msit",t),location.href=d+"?url="+encodeURIComponent(n)+"&"+r.toString()}(e,n)}))}function Se(){if(!W())throw v(l,"this api can be only called in child window")}function ye(e){if(!e.mst||!e.status)return Promise.reject(v(a,"no proper argument"));var t=JSON.stringify(e);return L(E("subWindowPost"),{method:"POST",body:t})}function Ie(e){var t=e.msit,n=e.mstVerifier;return t&&n?L(E("subWindowGetMSTByMSIT"),{method:"POST",body:JSON.stringify({msit:t,mstVerifier:n})}):Promise.reject(v(a,"no proper argument"))}function Ce(e){var t=e.mst;return t?L(E("subWindowGetAppData"),{method:"POST",body:JSON.stringify({mst:t})}):Promise.reject(v(a,"no proper argument"))}var Oe={on:function(e,t){k[e]||(k[e]=[]),k[e].push(t)},off:function(e,t){if(k[e]){var n=k[e].indexOf(t);n>=0&&k[e].splice(n,1)}},open:function(e){if(!b("subwindowOpen"))throw v(m,"No permission for liff.subWindow.open()");return function(){if(W())throw v(l,"this api can be only called in parent window")}(),g()?be(e):de(e)},cancel:function(e){return void 0===e&&(e={}),Se(),g()?function(e){return void 0===e&&(e={}),S(this,void 0,void 0,(function(){var t,n;return y(this,(function(i){switch(i.label){case 0:return(t=M())?[4,ye({mst:t,status:r.CANCEL,result:e})]:[2,Promise.reject(v(l,"mst is invalid"))];case 1:return n=i.sent(),X(!0),[2,n]}}))}))}(e):function(e){return void 0===e&&(e={}),oe(r.CANCEL,e)}(e)},submit:function(e){return void 0===e&&(e={}),Se(),g()?function(e){return void 0===e&&(e={}),S(this,void 0,void 0,(function(){var t,n;return y(this,(function(i){switch(i.label){case 0:return(t=M())?[4,ye({mst:t,status:r.SUBMIT,result:e})]:[2,Promise.reject(v(l,"mst is invalid"))];case 1:return n=i.sent(),X(!0),[2,n]}}))}))}(e):function(e){return void 0===e&&(e={}),oe(r.SUBMIT,e)}(e)},close:function(){return Se(),g()?function(){return S(this,void 0,void 0,(function(){var e;return y(this,(function(t){switch(t.label){case 0:return!1!==Q()?[3,2]:(e=M())?[4,ye({mst:e,status:r.CLOSE,result:{}})]:[2,Promise.reject(v(l,"mst is invalid"))];case 1:t.sent(),t.label=2;case 2:return A(),[2]}}))}))}():function(){return S(this,void 0,void 0,(function(){var e;return y(this,(function(t){return(null==(e=ne())?void 0:e.isReady())?(e.send({eventName:r.CLOSE}),[2,new Promise((function(e){setTimeout((function(){A(),e()}),s)}))]):(A(),[2,Promise.resolve()])}))}))}()},getAppData:function(){return Se(),function(){var e,t=B();try{e=t?JSON.parse(t):{}}catch(n){e={}}return Promise.resolve(e)}()}};export{Ce as getAppData,Ie as getMSTByMSIT,se as getMainWindowOrigin,ne as getMessageBus,te as initMessageBus,ie as setMainWindowOrigin,Oe as subWindow};
